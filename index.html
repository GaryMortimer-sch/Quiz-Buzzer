<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clifton Buzzer System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        .shape {
            width: 150px;
            height: 150px;
            transition: all 0.3s ease-in-out;
        }
        .circle { border-radius: 50%; }
        .square { border-radius: 1rem; }
        .triangle {
            width: 0;
            height: 0;
            background-color: transparent !important;
            border-left: 75px solid transparent;
            border-right: 75px solid transparent;
            border-bottom: 130px solid;
        }
        .buzzer-button:active {
            transform: scale(0.98);
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.2);
        }
        .pulsate {
            animation: pulsate-animation 1.5s infinite;
        }
        @keyframes pulsate-animation {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-red-700 text-white flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-5xl mx-auto text-center relative">

        <!-- Role Selection View -->
        <div id="role-selection-view">
            <h1 class="text-4xl md:text-5xl font-black mb-2">Clifton Buzzer System</h1>
            <p class="text-lg text-red-100 mb-8">Choose your role for this device.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button id="select-quiz-master" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-6 px-4 rounded-lg text-2xl shadow-lg">Quiz Master</button>
                <button id="select-display" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-6 px-4 rounded-lg text-2xl shadow-lg">Main Display</button>
                <button id="select-team" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-6 px-4 rounded-lg text-2xl shadow-lg">Team Buzzer</button>
            </div>
             <div class="mt-8 p-4 bg-red-600 rounded-lg">
                <p class="text-red-50">Your unique App ID for this session is:</p>
                <p id="app-id-display" class="font-mono text-xl text-yellow-300 break-all"></p>
            </div>
        </div>

        <!-- Team Selection View -->
        <div id="team-selection-view" class="hidden relative">
            <button id="back-to-roles-btn" class="absolute top-0 left-0 bg-red-600 hover:bg-red-500 text-white p-3 rounded-full shadow-lg z-10">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <h1 class="text-4xl font-bold mb-8">Select Your Team</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button data-team="trojans" class="team-select-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-4 rounded-lg text-2xl shadow-lg flex flex-col items-center">
                    <div class="w-12 h-12 bg-white rounded-full mb-2"></div>Trojans
                </button>
                <button data-team="barbarians" class="team-select-btn bg-green-600 hover:bg-green-700 text-white font-bold py-6 px-4 rounded-lg text-2xl shadow-lg flex flex-col items-center">
                     <div class="w-0 h-0 border-l-[24px] border-l-transparent border-r-[24px] border-r-transparent border-b-[42px] border-b-white mb-2"></div>Barbarians
                </button>
                <button data-team="crusaders" class="team-select-btn bg-red-600 hover:bg-red-700 text-white font-bold py-6 px-4 rounded-lg text-2xl shadow-lg flex flex-col items-center">
                    <div class="w-12 h-12 bg-white rounded-md mb-2"></div>Crusaders
                </button>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-app-view" class="hidden relative">
             <div id="home-button-container" class="absolute top-0 left-0 z-10">
                <button id="home-btn" class="bg-red-600 hover:bg-red-500 text-white p-3 rounded-full shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                </button>
            </div>

            <!-- Quiz Master UI -->
            <div id="quiz-master-ui" class="hidden space-y-6">
                <h1 class="text-3xl font-bold pt-12">Quiz Master Control</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div id="score-trojans" class="bg-blue-800 p-4 rounded-lg"><h2 class="text-xl font-bold">Trojans</h2><p class="text-5xl font-black">0</p></div>
                    <div id="score-barbarians" class="bg-green-800 p-4 rounded-lg"><h2 class="text-xl font-bold">Barbarians</h2><p class="text-5xl font-black">0</p></div>
                    <div id="score-crusaders" class="bg-red-800 p-4 rounded-lg"><h2 class="text-xl font-bold">Crusaders</h2><p class="text-5xl font-black">0</p></div>
                </div>
                <div id="buzzer-status-display" class="p-4 rounded-lg text-2xl font-bold bg-red-600 min-h-[68px] flex items-center justify-center">Waiting...</div>
                 <div id="master-controls" class="space-y-4">
                    <div id="post-buzz-controls" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button id="correct-btn" class="bg-green-500 hover:bg-green-600 font-bold p-4 rounded-lg">Correct (+1)</button>
                        <button id="incorrect-btn" class="bg-pink-500 hover:bg-pink-600 font-bold p-4 rounded-lg">Incorrect (-1)</button>
                        <button id="pass-btn" class="bg-sky-500 hover:bg-sky-600 font-bold p-4 rounded-lg">Pass to Next</button>
                    </div>
                     <button id="reset-round-btn" class="w-full bg-red-600 hover:bg-red-500 font-bold p-4 rounded-lg mt-4">RESET ROUND</button>
                     <button id="reset-scores-btn" class="w-full bg-red-500 hover:bg-red-400 font-bold p-4 rounded-lg mt-4">Reset All Scores</button>
                </div>
            </div>

            <!-- Display UI -->
            <div id="display-ui" class="hidden flex flex-col items-center justify-center min-h-[80vh] w-full">
                <div id="display-waiting" class="text-center">
                    <h1 class="text-6xl font-black">Waiting for Buzz...</h1>
                </div>
                <div id="display-buzzed" class="hidden text-center">
                    <div id="buzzed-shape-container" class="flex justify-center items-center mb-4 min-h-[150px]"></div>
                    <h1 id="buzzed-team-name" class="text-7xl font-black"></h1>
                </div>
            </div>

            <!-- Team UI -->
            <div id="team-ui" class="hidden flex flex-col items-center justify-center min-h-[80vh]">
                <h1 id="team-name-header" class="text-5xl font-bold mb-4"></h1>
                <div id="team-buzzer-button" class="w-full max-w-md h-64 rounded-2xl flex items-center justify-center text-5xl font-black cursor-pointer select-none buzzer-button transition-all"></div>
                <p id="team-status-text" class="mt-4 text-2xl text-red-100"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, runTransaction, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DO NOT EDIT ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'buzzer-app-default';
        // --- END DO NOT EDIT ---

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentRole = null;
        let currentTeam = null;
        const defaultGameState = {
            scores: { trojans: 0, barbarians: 0, crusaders: 0 },
            buzzerStatus: 'reset', // reset, locked
            buzzes: [], // { teamId, timestamp }
            answeringIndex: 0,
        };
        let gameState = { ...defaultGameState };
        const gameDocRef = doc(db, `artifacts/${appId}/public/data/buzzerGames`, 'live_game');

        const TEAMS = {
            trojans: { name: 'Trojans', color: 'bg-blue-600', hex: '#2563eb', shape: 'circle' },
            barbarians: { name: 'Barbarians', color: 'bg-green-600', hex: '#16a34a', shape: 'triangle' },
            crusaders: { name: 'Crusaders', color: 'bg-red-600', hex: '#dc2626', shape: 'square' }
        };

        const synths = {
            trojans: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 } }).toDestination(),
            barbarians: new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.05, release: 0.5 } }).toDestination(),
            crusaders: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.15, sustain: 0.15, release: 0.5 } }).toDestination()
        };
        const pitches = { trojans: 'C5', barbarians: 'G4', crusaders: 'E4' };

        const views = {
            roleSelection: document.getElementById('role-selection-view'),
            teamSelection: document.getElementById('team-selection-view'),
            mainApp: document.getElementById('main-app-view'),
        };
        const uis = {
            quizMaster: document.getElementById('quiz-master-ui'),
            display: document.getElementById('display-ui'),
            team: document.getElementById('team-ui'),
        };

        function showView(viewId) { Object.values(views).forEach(v => v.classList.add('hidden')); if (views[viewId]) views[viewId].classList.remove('hidden'); }
        function showUi(uiId) { Object.values(uis).forEach(u => u.classList.add('hidden')); if (uis[uiId]) uis[uiId].classList.remove('hidden'); }
        function goHome() { currentRole = null; currentTeam = null; showView('roleSelection'); }

        async function updateGameState(newState) {
            try {
                await setDoc(gameDocRef, { ...newState, lastActionTimestamp: serverTimestamp() }, { merge: true });
            } catch (e) { console.error("Error updating game state:", e); }
        }

        function setupFirestoreListener() {
            onSnapshot(gameDocRef, (doc) => {
                if (doc.exists()) {
                    gameState = { ...defaultGameState, ...doc.data() };
                    renderAll();
                } else if (currentRole === 'quizMaster') {
                    updateGameState(defaultGameState);
                }
            }, (error) => console.error("Firestore snapshot error:", error));
        }

        function renderAll() {
            if (!currentRole) return;
            switch (currentRole) {
                case 'quizMaster': renderQuizMaster(); break;
                case 'display': renderDisplay(); break;
                case 'team': renderTeam(); break;
            }
        }

        function renderQuizMaster() {
            const { scores, buzzerStatus, buzzes, answeringIndex } = gameState;
            Object.keys(scores).forEach(teamId => {
                document.querySelector(`#score-${teamId} p`).textContent = scores[teamId];
                document.getElementById(`score-${teamId}`).classList.remove('ring-4', 'ring-yellow-400');
            });

            const statusDisplay = document.getElementById('buzzer-status-display');
            const postBuzzControls = document.getElementById('post-buzz-controls');
            const passBtn = document.getElementById('pass-btn');

            if (buzzerStatus === 'locked') {
                postBuzzControls.classList.remove('hidden');
                const answeringTeamId = buzzes[answeringIndex]?.teamId;
                if (answeringTeamId) {
                    const team = TEAMS[answeringTeamId];
                    statusDisplay.textContent = `${team.name.toUpperCase()} is answering...`;
                    statusDisplay.className = `p-4 rounded-lg text-2xl font-bold ${team.color}`;
                    document.getElementById(`score-${answeringTeamId}`).classList.add('ring-4', 'ring-yellow-400');
                }
                passBtn.disabled = answeringIndex >= buzzes.length - 1;
            } else { // 'reset' state
                postBuzzControls.classList.add('hidden');
                statusDisplay.textContent = 'Ready For Next Question';
                statusDisplay.className = 'p-4 rounded-lg text-2xl font-bold bg-green-700 pulsate';
            }
        }

        function renderDisplay() {
            const { buzzerStatus, buzzes, answeringIndex } = gameState;
            const waitingView = document.getElementById('display-waiting');
            const buzzedView = document.getElementById('display-buzzed');

            [waitingView, buzzedView].forEach(v => v.classList.add('hidden'));

            if (buzzerStatus === 'locked' && buzzes.length > 0) {
                buzzedView.classList.remove('hidden');
                const answeringTeamId = buzzes[answeringIndex]?.teamId;
                const teamInfo = TEAMS[answeringTeamId];
                if (teamInfo) {
                    const shapeContainer = document.getElementById('buzzed-shape-container');
                    shapeContainer.innerHTML = teamInfo.shape === 'triangle'
                        ? `<div class="shape triangle" style="border-bottom-color: ${teamInfo.hex}"></div>`
                        : `<div class="shape ${teamInfo.shape} ${teamInfo.color}"></div>`;
                    document.getElementById('buzzed-team-name').textContent = teamInfo.name;
                }
            } else {
                waitingView.classList.remove('hidden');
                waitingView.querySelector('h1').textContent = 'Waiting for Buzz...';
            }
        }

        function renderTeam() {
            if (!currentTeam) return;
            const { buzzerStatus, buzzes, answeringIndex } = gameState;
            const teamInfo = TEAMS[currentTeam];
            const button = document.getElementById('team-buzzer-button');
            const statusText = document.getElementById('team-status-text');
            const answeringTeamId = buzzes[answeringIndex]?.teamId;

            document.getElementById('team-name-header').textContent = teamInfo.name;
            button.classList.remove('bg-green-500', 'bg-red-600', 'bg-yellow-500', 'pulsate', teamInfo.color);

            if (buzzerStatus === 'reset') {
                button.classList.add('bg-green-500', 'pulsate');
                button.textContent = 'BUZZ IN!';
                statusText.textContent = 'Ready for the next question!';
                button.dataset.enabled = "true";
            } else if (buzzerStatus === 'locked') {
                button.dataset.enabled = "false";
                if (answeringTeamId === currentTeam) {
                    button.classList.add('bg-yellow-500');
                    button.textContent = 'YOUR TURN!';
                    statusText.textContent = 'Answer now!';
                } else {
                    button.classList.add(teamInfo.color);
                    button.textContent = 'LOCKED';
                    statusText.textContent = `${TEAMS[answeringTeamId]?.name || 'A team'} is answering.`;
                }
            }
        }
        
        async function handleBuzzIn() {
            if (document.getElementById('team-buzzer-button').dataset.enabled !== "true") return;
            document.getElementById('team-buzzer-button').dataset.enabled = "false";
            
            await Tone.start();
            synths[currentTeam].triggerAttackRelease(pitches[currentTeam], "8n");

            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameDocRef);
                    if (!gameDoc.exists()) throw "Document does not exist!";
                    
                    const state = gameDoc.data();
                    if (state.buzzerStatus !== 'reset') return;

                    // Prevent duplicate buzzes from the same team in one round
                    if (state.buzzes.some(b => b.teamId === currentTeam)) return;

                    const newBuzz = { teamId: currentTeam, timestamp: new Date() };
                    const updatedBuzzes = [...state.buzzes, newBuzz].sort((a,b) => a.timestamp - b.timestamp);
                    
                    transaction.update(gameDocRef, { buzzerStatus: 'locked', buzzes: updatedBuzzes });
                });
            } catch (e) { console.error("Buzz-in transaction failed: ", e); }
        }

        function init() {
            document.getElementById('app-id-display').textContent = appId;
            onAuthStateChanged(auth, (user) => {
                if (user && !window.firestoreListenerAttached) {
                    setupFirestoreListener();
                    window.firestoreListenerAttached = true;
                }
            });

            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) { console.error("Authentication failed:", error); }
            })();

            // Navigation
            document.getElementById('home-btn').addEventListener('click', goHome);
            document.getElementById('back-to-roles-btn').addEventListener('click', goHome);

            // Role Selection
            document.getElementById('select-quiz-master').addEventListener('click', () => { currentRole = 'quizMaster'; showView('mainApp'); showUi('quizMaster'); renderAll(); });
            document.getElementById('select-display').addEventListener('click', () => { currentRole = 'display'; showView('mainApp'); showUi('display'); renderAll(); });
            document.getElementById('select-team').addEventListener('click', () => showView('teamSelection'));

            // Team Selection
            document.querySelectorAll('.team-select-btn').forEach(btn => {
                btn.addEventListener('click', () => { currentRole = 'team'; currentTeam = btn.dataset.team; showView('mainApp'); showUi('team'); renderAll(); });
            });
            
            // Team Buzzer
            document.getElementById('team-buzzer-button').addEventListener('click', handleBuzzIn);
            window.addEventListener('keyup', (e) => { if (currentRole === 'team' && e.code === 'Space') { e.preventDefault(); handleBuzzIn(); } });

            // Master Controls
            document.getElementById('reset-round-btn').addEventListener('click', () => updateGameState({ buzzerStatus: 'reset', buzzes: [], answeringIndex: 0 }));

            document.getElementById('correct-btn').addEventListener('click', () => {
                const answeringTeamId = gameState.buzzes[gameState.answeringIndex]?.teamId;
                if (!answeringTeamId) return;
                const newScores = { ...gameState.scores, [answeringTeamId]: gameState.scores[answeringTeamId] + 1 };
                updateGameState({ scores: newScores, buzzerStatus: 'reset', buzzes: [], answeringIndex: 0 });
            });

            document.getElementById('incorrect-btn').addEventListener('click', () => {
                const answeringTeamId = gameState.buzzes[gameState.answeringIndex]?.teamId;
                if (!answeringTeamId) return;
                const newScores = { ...gameState.scores, [answeringTeamId]: gameState.scores[answeringTeamId] - 1 };
                if (gameState.answeringIndex >= gameState.buzzes.length - 1) { // Last one incorrect
                    updateGameState({ scores: newScores, buzzerStatus: 'reset', buzzes: [], answeringIndex: 0 });
                } else { // Pass to next
                    updateGameState({ scores: newScores, answeringIndex: gameState.answeringIndex + 1 });
                }
            });
            
            document.getElementById('pass-btn').addEventListener('click', () => {
                if (gameState.answeringIndex < gameState.buzzes.length - 1) {
                    updateGameState({ answeringIndex: gameState.answeringIndex + 1 });
                }
            });

            const resetScoresBtn = document.getElementById('reset-scores-btn');
            resetScoresBtn.addEventListener('click', async () => {
                if (resetScoresBtn.dataset.confirm === 'true') {
                    updateGameState({ ...defaultGameState });
                    resetScoresBtn.dataset.confirm = 'false';
                    resetScoresBtn.textContent = 'Reset All Scores';
                    resetScoresBtn.classList.replace('bg-yellow-500', 'bg-red-500');
                } else {
                    resetScoresBtn.dataset.confirm = 'true';
                    resetScoresBtn.textContent = 'Confirm Reset?';
                    resetScoresBtn.classList.replace('bg-red-500', 'bg-yellow-500');
                    setTimeout(() => {
                        if (resetScoresBtn.dataset.confirm === 'true') {
                            resetScoresBtn.dataset.confirm = 'false';
                            resetScoresBtn.textContent = 'Reset All Scores';
                            resetScoresBtn.classList.replace('bg-yellow-500', 'bg-red-500');
                        }
                    }, 3000);
                }
            });

            showView('roleSelection');
        }

        init();
    </script>
</body>
</html>


